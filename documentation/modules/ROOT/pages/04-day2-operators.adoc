== Configure operators

Once authentication is configured, we are going to deploy some operators. Operatos helm charts use range values so we can define as many operators as we want on values section.

We are going to deploy tekton, kiali, jaeger, servicemesh and nmstate operator. Furthermore we are going to deploy Service Mesh Control Plane and Member Roll and an example application called bookinfo for service mesh.

Go to your working branch and create a file called *values-operators.yaml*:

[.lines_7]
[.console-input]
[source, shell,subs="+macros,+attributes"]
----
operators:
  enabled: true
  operators:
    tekton:
      enabled: true
    knative:
      enabled: true
    kiali:
      enabled: true
    jaeger:
      enabled: true
    servicemesh:
      enabled: true 
    nmstate:
      enabled: true  
  istio:
    enabled: true      
---- 

Then create Application:

[.lines_7]
[.console-input]
[source, shell,subs="+macros,+attributes"]
----
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sno-<name>-operators
  namespace: openshift-gitops
spec:
  destination:
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      valueFiles:
        - values-operators.yaml
    path: .
    repoURL: 'https://github.com/<your_user>/helm-infra-gitops-workshop.git'
    targetRevision: sno-<name>
  syncPolicy:
    automated:
      prune: true
      selfHeal: true   
---- 

Helm charts includes subcription definition for each operator in the last version available in stable channel, while Install Plan is set to Automatic so we do not need to manually approve installation.
This is all set in values as parameters so we can use these charts for different installation methods by overriding those values.

In this case sync waves and healthchecks are very important as for being able to deploy bookinfo app, operator must be installed in the first place but also mesh should be configured.

If sync waves are not configured properly it will try to create reosurces whose api still doesn't exist in the cluster.

Once operators are installed you can view them as well with the Install Plan managed by argo:

image::operators-install-plan.png[]

Then, deploy bookinfo app using argocd-apps instance. You will realize you only need to deploy apps components as namespace is already managed by argocd-infra instance:

[.lines_7]
[.console-input]
[source, shell,subs="+macros,+attributes"]
----
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sno-<name>-bookinfo
  namespace: openshift-operators
spec:
  destination:
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      parameters:
        - name: bookinfo.enabled
          value: 'true'
    path: .
    repoURL: 'https://github.com/<your_user>/helm-infra-gitops-workshop.git'
    targetRevision: sno-<name>
  syncPolicy:
    automated:
      prune: true
      selfHeal: true   
---- 