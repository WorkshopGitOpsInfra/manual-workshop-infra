<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Managed cluster setup :: Lab GitOps infra</title>
    <link rel="canonical" href="https://github.com/romerobu/manual-workshop-infra/template-tutorial/03-sno-setup.html">
    <link rel="prev" href="02-hub-setup.html">
    <link rel="next" href="03-sno-setup-helm.html#charts">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://github.com/romerobu/manual-workshop-infra">Lab GitOps infra</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="template-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-hub-setup.html">2. Deploy Hub setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#hub">2.1 Hub setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-sno-setup.html">3. Deploy Managed setup</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="03-sno-setup.html">3.1. Managed setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-sno-setup-helm.html#charts">3.2. Helm charts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-day2-config.html">4. Day 2</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-oauth.html#oauth">4.1 Configure Identity Providers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-operators.html#operators">4.2 Deploy Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-monitoring.html#monitoring">4.3 Configure Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-namespace.html#namespace">4.4 Namespace configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-nmstate.html#namespace">4.5 NMstate configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-vault.html#vault">4.6 Vault configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-appset.html#appset">4.7 Day 2 with ApplicationSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-challenges.html">5. Challenges</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-challenges.html#challenges">5.1 Challenges</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Lab GitOps infra</a></li>
    <li><a href="03-sno-setup.html">3. Deploy Managed setup</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/romerobu/manual-workshop-infra/edit/master/documentation/modules/ROOT/pages/03-sno-setup.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Managed cluster setup</h1>
<div class="paragraph">
<p>Then checkout and create a new branch for your user.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">git branch # main
git checkout -b sno-&lt;name&gt;-setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Argo hub setup has been already performed, so you just need to focused on managed your single node cluster.</p>
</div>
<div class="paragraph">
<p>As every user is deploying its own bootstrap file, they must have an unique name and they should be deployed on your scoped project where your user has privileges.</p>
</div>
<div class="paragraph">
<p>Then you will have to replace &lt;name&gt; by your cluster and your repo url to your github account.</p>
</div>
<div class="paragraph">
<p>Make sure after cluster-definition, the following folder (sno-&lt;name&gt;) is named as your assigned cluster as this value will be used as a parameter for ApplicationSet.
Then update cluster.json values.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">{
  "environment": "dev",
  "cloud": "aws",
  "project": "project-sno-&lt;name&gt;",
  "region": "&lt;region&gt;",
  "cluster": {
    "name": "sno-&lt;name&gt;",
    "address": "https://api.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com:6443"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must also update managed-setup-a for your own managed cluster. Note how this application deploys to a different namespace and argo instance compared to hub-setup application:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: managed-setup-a-&lt;name&gt;
  namespace: openshift-operators
spec:
  destination:
    namespace: openshift-operators
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: project-sno-&lt;name&gt;
  source:
    repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
    targetRevision: sno-&lt;name&gt;-setup
    path: cluster-addons/cluster-addons-as/
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The source path of this Application points to the <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/application-set/">ApplicationSet</a> used.
ApplicationSet is a CR that can be uset to genereate Applications to multiple cluster from multiple originis. ApplicationSet controller is installed alongside Argo CD
even though it must be explicitaly enabled.</p>
</div>
<div class="paragraph">
<p>ApplicationSet is a helpful approach for multi cluster management, and it "supplements Argo CD by adding additional features in support of cluster-administrator-focused scanerios". Some of those are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ability to use a single Kubernetes manifest to target multiple Kubernetes clusters with Argo CD.</p>
</li>
<li>
<p>Ability to use a single Kubernetes manifest to deploy multiple applications from one or multiple Git repositories with Argo CD.</p>
</li>
<li>
<p>Improved support for monorepos (multiple Argo CD Application resources defined within a single Git repository).</p>
</li>
<li>
<p>Improves ability of individual cluster tenants to deploy applications using ArgoCD (without needing to involve privileged cluster admin in enabling the destanion servers).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ApplicationSet uses generators to create Application with multiple origins and destinations using templating.</p>
</div>
<div class="paragraph">
<p><a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators/">Generator</a> used may vary depending on your use case, in this example
we are using Git Files generator so cluster definition values are used as parameters. In case we had N cluster-definition files, the ApplicationSet would generate N Applications automatically.</p>
</div>
<div class="paragraph">
<p>As we did before, we should update ApplicationSet name with your lab data.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: gitops-setup-sno-&lt;name&gt;
  namespace: openshift-operators
spec:
  generators:
  - git:
      repoURL: <a href="https://github.com/romerobu/workshop-gitops-content-deploy.git" class="bare">https://github.com/romerobu/workshop-gitops-content-deploy.git</a>
      revision: sno-&lt;name&gt;-setup
      files:
      - path: "cluster-definition/**/cluster.json"
  template:
    metadata:
      name: 'gitops-setup-{{cluster.name}}-a'
    spec:
      project: '{{project}}'
      source:
        repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
        targetRevision: sno-&lt;name&gt;-setup
        path: cluster-addons/charts/gitops-setup
      destination:
        server: '{{cluster.address}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This first ApplicationSet deploys the operator and an initial non default cluster wide instance for day 2 and infra operations.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: bootstrap-sno-&lt;name&gt;
  namespace: openshift-operators
spec:
  generators:
  - git:
      repoURL: <a href="https://github.com/romerobu/workshop-gitops-content-deploy.git" class="bare">https://github.com/romerobu/workshop-gitops-content-deploy.git</a>
      revision: sno-&lt;name&gt;-setup
      files:
      - path: "cluster-definition/**/cluster.json"
  template:
    metadata:
      name: 'bootstrap-{{cluster.name}}-a'
    spec:
      project: '{{project}}'
      source:
        repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
        targetRevision: sno-&lt;name&gt;-setup
        path: cluster-addons/charts/bootstrap-app
      destination:
        server: '{{cluster.address}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then update bootstrap-app values.yaml file with your cluster data too:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">clusters:
  sno-&lt;name&gt;:
    applicationNamespace: openshift-gitops
    namespace: ''
    destination: 'https://kubernetes.default.svc'
    project: default
    code:
      repo: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
      path: cluster-addons/charts/bootstrap
      target: sno-&lt;name&gt;-setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>This ApplicationSet deploys an Application on the recently deployed instance on destination cluster to deploy and manage a second instance for applications.</p>
</div>
<div class="paragraph">
<p>Then navigate under source path to take a look to the Helm charts used for deploying GitOps and setting up the initial config for managed clusters.</p>
</div>
<div class="paragraph">
<p><strong>Reminder</strong>: ApplicationSet controller is not enabled by default and must be configured on argocd instance.</p>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-hub-setup.html">2. Deploy Hub setup</a></span>
  <span class="next"><a href="03-sno-setup-helm.html#charts">3.2. Helm charts</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
