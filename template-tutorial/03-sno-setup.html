<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy Managed Cluster Setup :: GitOps Infrastructure Configuration Workshop</title>
    <link rel="canonical" href="https://github.com/romerobu/manual-workshop-infra/template-tutorial/03-sno-setup.html">
    <link rel="prev" href="02-hub-setup.html">
    <link rel="next" href="04-day2-config.html#daytwooperations">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://github.com/romerobu/manual-workshop-infra">GitOps Infrastructure Configuration Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="template-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Table of Contents</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#gettutorialsources">1.2 Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-hub-setup.html">2. Deploy Hub Cluster Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#laboverview">2.1 Lab overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#environment">2.2 Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#hubsetup">2.3 Hub setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-sno-setup.html">3. Deploy Managed Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#managedconfiguration">3.1. Managed configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#helmcharts">3.2. Helm charts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-day2-config.html#daytwooperations">4. Day-2 Operations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#identityproviders">4.1 Configure Identity Providers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#deployoperators">4.2 Deploy Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#monitoring">4.3 Configure Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#namespace">4.4 Namespace configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#vault">4.6 Vault configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#appset">4.7 Day 2 with ApplicationSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-challenges.html">5. Challenges</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Lab GitOps infra</a></li>
    <li><a href="03-sno-setup.html">3. Deploy Managed Setup</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/romerobu/manual-workshop-infra/edit/master/documentation/modules/ROOT/pages/03-sno-setup.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Deploy Managed Cluster Setup</h1>
<div class="sect1">
<h2 id="managedconfiguration"><a class="anchor" href="#managedconfiguration"></a>Managed configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Checkout to your working branch.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">git checkout sno-&lt;name&gt;-setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Argo hub setup has been already performed, so you just need to focused on managed your single node cluster.</p>
</div>
<div class="paragraph">
<p>As every user is deploying its own bootstrap file, they must have an unique name and they should be deployed on your scoped project where your user has privileges.</p>
</div>
<div class="paragraph">
<p>Then you will have to replace &lt;name&gt; by your cluster and your repo url to your github account.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Make sure after cluster-definition, the following folder <strong>(sno-&lt;name&gt;)</strong> is named as your assigned cluster as this value will be used as a parameter for ApplicationSet.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then update cluster.json values.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">{
  "environment": "dev",
  "cloud": "aws",
  "project": "project-sno-&lt;name&gt;",
  "region": "&lt;region&gt;",
  "cluster": {
    "name": "sno-&lt;name&gt;",
    "address": "https://api.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com:6443"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must also update managed-setup-a-&lt;name&gt; for your own managed cluster. Note how this application deploys to a different namespace and argo instance compared to hub-setup application:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: managed-setup-a-&lt;name&gt;
  namespace: openshift-operators
spec:
  destination:
    namespace: openshift-operators
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: project-sno-&lt;name&gt;
  source:
    repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
    targetRevision: sno-&lt;name&gt;-setup
    path: cluster-addons/cluster-addons-as/
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The source path of this Application points to the ApplicationSet used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Learn more about <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/application-set/">ApplicationSets</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ApplicationSet is a CR that can be used to genereate Applications to multiple cluster from multiple originis. ApplicationSet controller is installed alongside Argo CD
even though it must be explicitaly enabled.</p>
</div>
<div class="paragraph">
<p>ApplicationSet is a helpful approach for multi cluster management, and it supplements Argo CD by adding additional features in support of cluster-administrator-focused scanerios. Some of those are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ability to use a single Kubernetes manifest to target multiple Kubernetes clusters with Argo CD.</p>
</li>
<li>
<p>Ability to use a single Kubernetes manifest to deploy multiple applications from one or multiple Git repositories with Argo CD.</p>
</li>
<li>
<p>Improved support for monorepos (multiple Argo CD Application resources defined within a single Git repository).</p>
</li>
<li>
<p>Improves ability of individual cluster tenants to deploy applications using ArgoCD (without needing to involve privileged cluster admin in enabling the destanion servers).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ApplicationSet uses generators to create Application with multiple origins and destinations using templating.</p>
</div>
<div class="paragraph">
<p>Generator used may vary depending on your use case, in this example
we are using Git Files generator so cluster definition values are used as parameters. In case we had N cluster-definition files, the ApplicationSet would generate 'N' Applications automatically.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Find more about <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators/">generators</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
As we did before, we should update ApplicationSet name with your lab data.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This first ApplicationSet deploys the operator and an initial non default cluster wide instance for day 2 and infra operations.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: gitops-setup-sno-&lt;name&gt;
  namespace: openshift-operators
spec:
  generators:
  - git:
      repoURL: <a href="https://github.com/romerobu/workshop-gitops-content-deploy.git" class="bare">https://github.com/romerobu/workshop-gitops-content-deploy.git</a>
      revision: sno-&lt;name&gt;-setup
      files:
      - path: "cluster-definition/**/cluster.json"
  template:
    metadata:
      name: 'gitops-setup-{{cluster.name}}-a'
    spec:
      project: '{{project}}'
      source:
        repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
        targetRevision: sno-&lt;name&gt;-setup
        path: cluster-addons/charts/gitops-setup
      destination:
        server: '{{cluster.address}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second ApplicationSet bootstrap-sno-&lt;name&gt; deploys an Application in the argocd-infra instance on manged-cluster, called sno-setup, with configuration like: rbac, a second argocd.apps instance, namespaces and vault.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: bootstrap-sno-&lt;name&gt;
  namespace: openshift-operators
spec:
  generators:
  - git:
      repoURL: <a href="https://github.com/romerobu/workshop-gitops-content-deploy.git" class="bare">https://github.com/romerobu/workshop-gitops-content-deploy.git</a>
      revision: sno-&lt;name&gt;-setup
      files:
      - path: "cluster-definition/**/cluster.json"
  template:
    metadata:
      name: 'bootstrap-{{cluster.name}}-a'
    spec:
      project: '{{project}}'
      source:
        repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
        targetRevision: sno-&lt;name&gt;-setup
        path: cluster-addons/charts/bootstrap-app
      destination:
        server: '{{cluster.address}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then update bootstrap-app values.yaml file with your cluster data too:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">clusters:
  sno-&lt;name&gt;:
    applicationNamespace: openshift-gitops
    namespace: ''
    destination: 'https://kubernetes.default.svc'
    project: default
    code:
      repo: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
      path: cluster-addons/charts/bootstrap
      target: sno-&lt;name&gt;-setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally replace values in bootstrap values.yaml file;</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">...
vault:
  vault_addr: "http://vault-vault.apps.argo-hub.&lt;domain&gt;.opentlc.com"
  avp_type: vault
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This ApplicationSet deploys an Application on the recently deployed instance on destination cluster to deploy and manage a second instance for applications.</p>
</div>
<div class="paragraph">
<p>Then navigate under source path to take a look to the Helm charts used for deploying GitOps and setting up the initial config for managed clusters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
ApplicationSet controller is not enabled by default and must be configured on argocd instance.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="helmcharts"><a class="anchor" href="#helmcharts"></a>Helm charts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Helm chart is a set of YAML manifests and templates that describes Kubernetes resources (Deployments, Secrets, CRDs, etc.) and defined configurations needed for the Kubernetes application.</p>
</div>
<div class="paragraph">
<p>In the hub argocd instance, the first Helm chart is <strong>gitops-setup</strong>, which deploys GitOps operator on managed clusters. This chart is intented to deploy any kind of operator, even though in this case we are
only deploying GitOps operator.</p>
</div>
<div class="paragraph">
<p>If you navigate to subscription.yaml resource you will see there is a global value for applying env variables for GitOps.</p>
</div>
<div class="paragraph">
<p>These config values disable the default argocd instance and enables a new instance to be cluster wide. This means this argo application controller sa will have
permissions to work in all namespaces within the cluster.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: {{ $key }}
  namespace: {{ $val.namespace }}
  {{- if $.Values.global.argocd.enabled }}
  annotations:
    argocd.argoproj.io/sync-wave: "-5"
  {{- end }}
spec:
  channel: {{ $val.channel }}
  installPlanApproval: {{ $val.approval }}
  name: {{ $val.name }}
  source: redhat-operators
  sourceNamespace: openshift-marketplace
{{- if $val.csv }}
  startingCSV: {{ $val.csv }}
{{- end }}
{{- if $.Values.operators.gitops.enabled }}
  config:
    env:
    - name: ARGOCD_CLUSTER_CONFIG_NAMESPACES
      value: openshift-gitops # namespace of argocd instance
    - name: DISABLE_DEFAULT_ARGOCD_INSTANCE
      value: "true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default any new instance created is namespace scoped, this means you will only be allowed to deploy within your namespace. If you want to deploy across all namespace
you need to change this configuration to make the instance cluster wide. Additionally your argo sa may not have privileges enough to work with cluster wide resources and you might need to
assign a new role binding for it.</p>
</div>
<div class="paragraph">
<p>You can either create a custom role binding or labelling any managed namespace by argo so it will create this role binding automatically only for that namespace.</p>
</div>
<div class="paragraph">
<p>After setting this global var you can see a new cluster role binding for this sa and this configuration on argocd console.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-wide-role-binding.png" alt="cluster wide role binding">
</div>
<div class="title">Figure 1. Cluster role binding</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Take a look to:
<a href="https://developers.redhat.com/articles/2023/03/06/5-global-environment-variables-provided-openshift-gitops#5_environment_variables__overview">global env vars</a>, <a href="https://docs.openshift.com/container-platform/4.10/cicd/gitops/setting-up-argocd-instance.html#gitops-deploy-resources-different-namespaces_setting-up-argocd-instance">how to label namespaces</a>
and <a href="https://docs.openshift.com/container-platform/4.12/cicd/gitops/configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations.html#gitops-additional-permissions-for-cluster-config_configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations">how to create a role binding</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the operator is running, we need to deploy ArgoCD instance. To make sure instance is deployed after the operator is running we use sync waves and custom resources healthcheck.</p>
</div>
<div class="paragraph">
<p>Sync waves are defined on each resource as annotations, and they tell argo the order in which resources should be applied once the previous is already in healthy status.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can take a look in detail to the <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/sync-waves/">Sync waves</a> documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For some specific resources they need a custom healthcheck. Most of the objects only require existing to work but others like subscription may exists but not progress to a successful status so we need a custom healthcheck to make sure the next sync wave does not start till the operators are properly installed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can take a look in detail to the <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/health/">Custom Healthcheck</a> documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Resource healthcheck is defined in the argo instace, which is also deployed using helm charts.</p>
</div>
<div class="paragraph">
<p>Navigate to SNO argocd-infra instance and take a look to the <strong>resourceCustomizations</strong> section, as well as other configurations that we will review later on.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kind: ArgoCD
apiVersion: argoproj.io/v1alpha1
metadata:
  name: {{ $.Values.argocd.name }}
  namespace: {{ $.Values.argocd.controller }}
  {{- if $.Values.argocd.enabled }}
  annotations:
    argocd.argoproj.io/sync-wave: "-10"
  {{- end }}
spec:
  sso:
    dex:
      openShiftOAuth: true
      resources:
        limits:
          cpu: 500m
          memory: 256Mi
        requests:
          cpu: 250m
          memory: 128Mi
    provider: dex
  resourceTrackingMethod: annotation+label
  applicationSet:
    logLevel: info
  controller:
    logLevel: debug
    resources:
      limits:
        cpu: 2000m
        memory: 2048Mi
      requests:
        cpu: 250m
        memory: 1024Mi
  ha:
    enabled: false
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi
  rbac:
    defaultPolicy: ''
    policy: |-
      g, system:cluster-admins, role:admin
      g, cluster-admins, role:admin
    scopes: '[groups]'
  redis:
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi
  repo:
    resources:
      limits:
        cpu: 1000m
        memory: 1024Mi
      requests:
        cpu: 250m
        memory: 256Mi
  resourceExclusions: "- apiGroups:\n  - tekton.dev\n  clusters:\n  - '*'\n  kinds:\n  - TaskRun\n  - PipelineRun        \n"
  server:
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 125m
        memory: 128Mi
    route:
      enabled: true
  resourceCustomizations: |
    operators.coreos.com/Subscription:
      health.lua: |
        health_status = {}
        if obj.status ~= nil then
          if obj.status.conditions ~= nil then
            numDegraded = 0
            numPending = 0
            msg = ""
            for i, condition in pairs(obj.status.conditions) do
              msg = msg .. i .. ": " .. condition.type .. " | " .. condition.status .. "\n"
              if condition.type == "InstallPlanPending" and condition.status == "True" then
                numPending = numPending + 1
              elseif (condition.type == "InstallPlanMissing" and condition.reason ~= "ReferencedInstallPlanNotFound") then
                numDegraded = numDegraded + 1
              elseif (condition.type == "CatalogSourcesUnhealthy" or condition.type == "InstallPlanFailed" or condition.type == "ResolutionFailed") and condition.status == "True" then
                numDegraded = numDegraded + 1
              end
            end
            if numDegraded == 0 and numPending == 0 then
              health_status.status = "Healthy"
              health_status.message = msg
              return health_status
            elseif numPending &gt; 0 and numDegraded == 0 then
              health_status.status = "Progressing"
              health_status.message = "An install plan for a subscription is pending installation"
              return health_status
            else
              health_status.status = "Degraded"
              health_status.message = msg
              return health_status
            end
          end
        end
        health_status.status = "Progressing"
        health_status.message = "An install plan for a subscription is pending installation"
        return health_status</code></pre>
</div>
</div>
<div class="paragraph">
<p>This first instance <strong>argocd-infra</strong> is intended for day 2 and infra operations and namespace creation and management.</p>
</div>
<div class="paragraph">
<p>Next chart is <strong>bootstrap-app</strong>. This chart deploys an Application on argocd-infra instance to apply <strong>bootstrap</strong> chart.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">{{- range $key, $val := $.Values.clusters }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $key }}-bootstrap
  namespace: {{ $val.applicationNamespace }}
spec:
  destination:
    server: {{ $val.destination }}
    namespace: ''
  project: {{ $val.project }}
  source:
    helm:
      valueFiles:
        - values.yaml
    path: {{ $val.code.path }}
    repoURL: {{ $val.code.repo }}
    targetRevision: {{ $val.code.target }}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
{{- end }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then on <strong>bootstrap</strong> folder you can find resources for deploying a second <strong>argocd-apps</strong> instance, namespaces, vault and rbac configuration.</p>
</div>
<div class="paragraph">
<p>Argo instance is slightly similar to the first one but it has some special customization, lets take a look:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kind: ArgoCD
apiVersion: argoproj.io/v1alpha1
metadata:
  name: {{ $.Values.argocd.name }}
  namespace: {{ $.Values.operators.gitops.namespace }}
  {{- if $.Values.global.argocd.enabled }}
  annotations:
    argocd.argoproj.io/sync-wave: "5"
  {{- end }}
spec:
  sso:
    dex:
      openShiftOAuth: true # 1
      resources:
        limits:
          cpu: 500m
          memory: 256Mi
        requests:
          cpu: 250m
          memory: 128Mi
    provider: dex
  resourceTrackingMethod: annotation+label # 2
  applicationSet: # 3
    logLevel: info
  controller:
    resources:
      limits:
        cpu: 2000m
        memory: 2048Mi
      requests:
        cpu: 250m
        memory: 1024Mi
  ha:
    enabled: false
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi
  rbac: # 4
    defaultPolicy: ''
    policy: |-
      g, {{ $.Values.argocd.group }}, role:admin
      p, role:operator, applications, get, */*, allow
      p, role:operator, applications, sync, */*, allow
      g, argo-admins, role:admin
      g, argo-readers, role:readonly
      g, argo-operators, role:operator
      g, argo-dev-operators, role:operator-dev
    scopes: '[groups]'
  redis:
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi
  repo:
    resources:
      limits:
        cpu: 1000m
        memory: 1024Mi
      requests:
        cpu: 250m
        memory: 256Mi
    env:
        - name: AVP_AUTH_TYPE
          valueFrom:
            secretKeyRef:
              key: AVP_AUTH_TYPE
              name: argocd-vault-plugin-credentials
        - name: AVP_TYPE
          valueFrom:
            secretKeyRef:
              key: AVP_TYPE
              name: argocd-vault-plugin-credentials
        - name: VAULT_ADDR
          valueFrom:
            secretKeyRef:
              key: VAULT_ADDR
              name: argocd-vault-plugin-credentials
        - name: AVP_K8S_ROLE
          valueFrom:
            secretKeyRef:
              key: AVP_K8S_ROLE
              name: argocd-vault-plugin-credentials
    mountsatoken: true
    sidecarContainers: # 5
      - command:
          - /var/run/argocd/argocd-cmp-server
        image: 'quay.io/argoproj/argocd:v2.4.8'
        name: avp-helm
        volumeMounts:
          - mountPath: /var/run/argocd
            name: var-files
          - mountPath: /home/argocd/cmp-server/plugins
            name: plugins
          - mountPath: /tmp
            name: tmp-dir
          - mountPath: /home/argocd/cmp-server/config
            name: cmp-plugin
          - mountPath: /usr/local/bin/argocd-vault-plugin
            name: custom-tools
            subPath: argocd-vault-plugin
    volumeMounts:
      - mountPath: /usr/local/bin/argocd-vault-plugin
        name: custom-tools
        subPath: argocd-vault-plugin
    volumes:
      - configMap:
          name: cmp-plugin
        name: cmp-plugin
      - emptyDir: {}
        name: custom-tools
      - emptyDir: {}
        name: tmp-dir
    initContainers:
      - args:
          - &gt;-
            wget -O /custom-tools/argocd-vault-plugin
            <a href="https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v${AVP_VERSION}/argocd-vault-plugin_${AVP_VERSION}_linux_amd64" class="bare">https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v${AVP_VERSION}/argocd-vault-plugin_${AVP_VERSION}_linux_amd64</a>
            &amp;&amp; chmod +x /custom-tools/argocd-vault-plugin &amp;&amp; ls -la
            /custom-tools/
        command:
          - sh
          - '-c'
        env:
          - name: AVP_VERSION
            value: 1.11.0
        image: 'alpine:3.8'
        name: download-tools
        volumeMounts:
          - mountPath: /custom-tools
            name: custom-tools
  resourceExclusions: "- apiGroups:\n  - tekton.dev\n  clusters:\n  - '*'\n  kinds:\n  - TaskRun\n  - PipelineRun        \n"
  server:
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 125m
        memory: 128Mi
    route:
      enabled: true
  configManagementPlugins: | # 6
    - name: argocd-vault-plugin
      generate:
        command: ["argocd-vault-plugin"]
        args: ["generate", "./"]
  resourceCustomizations: | # 7
    operators.coreos.com/Subscription:
      health.lua: |
        health_status = {}
        if obj.status ~= nil then
          if obj.status.conditions ~= nil then
            numDegraded = 0
            numPending = 0
            msg = ""
            for i, condition in pairs(obj.status.conditions) do
              msg = msg .. i .. ": " .. condition.type .. " | " .. condition.status .. "\n"
              if condition.type == "InstallPlanPending" and condition.status == "True" then
                numPending = numPending + 1
              elseif (condition.type == "InstallPlanMissing" and condition.reason ~= "ReferencedInstallPlanNotFound") then
                numDegraded = numDegraded + 1
              elseif (condition.type == "CatalogSourcesUnhealthy" or condition.type == "InstallPlanFailed" or condition.type == "ResolutionFailed") and condition.status == "True" then
                numDegraded = numDegraded + 1
              end
            end
            if numDegraded == 0 and numPending == 0 then
              health_status.status = "Healthy"
              health_status.message = msg
              return health_status
            elseif numPending &gt; 0 and numDegraded == 0 then
              health_status.status = "Progressing"
              health_status.message = "An install plan for a subscription is pending installation"
              return health_status
            else
              health_status.status = "Degraded"
              health_status.message = msg
              return health_status
            end
          end
        end
        health_status.status = "Progressing"
        health_status.message = "An install plan for a subscription is pending installation"
        return health_status</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Dex uses groups and users defined within Openshift by checking the Oauth server</p>
</li>
<li>
<p>Overrides default tracking method by label to annotation+label</p>
</li>
<li>
<p>Enable ApplicationSet controller</p>
</li>
<li>
<p>Configure argo RBAC</p>
</li>
<li>
<p>Configure vault plugin as a sidecar container</p>
</li>
<li>
<p>Configure new plugin for vault</p>
</li>
<li>
<p>Configure resource healthcheck for Subscription</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you may notice this instance contains some parametes for configuring vault plugin (which we will discuss later) and rbac model.</p>
</div>
<div class="paragraph">
<p>RBAC is defined on <strong>rbac</strong> folder and includes the basic configuration for argo RBAC and projects.</p>
</div>
<div class="paragraph">
<p>The RBAC feature enables restriction of access to Argo CD resources. Argo CD does not have its own user management system and has only one built-in user admin.
The admin user is a superuser and it has unrestricted access to the system. RBAC requires SSO configuration or one or more local users setup.
Once SSO or local users are configured, additional RBAC roles can be defined, and SSO groups or local users can then be mapped to roles.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/rbac/">RBAC</a> documentation
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Argo CD has two pre-defined roles but RBAC configuration allows defining roles and groups (see below).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>role:readonly - read-only access to all resources</p>
</li>
<li>
<p>role:admin - unrestricted access to all resources</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally to the defined roles, it is possible to create some specific roles to allow argo-operators and argo-dev-operators group members manage applications in Argo CD.</p>
</div>
<div class="paragraph">
<p>Then if you navigate to rbac folder you can see a Group and a Role binding resource to give cluster-admin permissions on argo to the admin user configured via Htpasswd.</p>
</div>
<div class="paragraph">
<p>For RBAC we need to differentiate between global configuration on argocd intance and projects RBAC.</p>
</div>
<div class="paragraph">
<p>If you navigate to rbac section on argo instance, you will see some rbac policies starting like <strong>g</strong>  and <strong>p</strong>.</p>
</div>
<div class="paragraph">
<p>Policies starting with g assign roles to openshift local groups (they can be both argo roles and ocp roles) and their users, while policies starting with p define specific policies for projects, resources, projects and applications and their operations.</p>
</div>
<div class="paragraph">
<p>The following sections collect the information around Argo CD Roles and Argo CD permission in the managed clusters. It is important to understand the functionality matrix and permission that the following sections try to implement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>argo-admins: group members have full permissions in Argo CD to admin</p>
</li>
<li>
<p>argo-readers: group members have read-only permissions in Argo CD to access all information</p>
</li>
<li>
<p>argo-operators: group members have permission to manage applications (get and sync) only in Argo CD</p>
</li>
<li>
<p>argo-dev-operators: group members have permission to manage applications (get and sync) only in Argo CD dev project</p>
</li>
<li>
<p>apimanager01: user has no permissions to see anything in Argo CD but has permissions to create objects in the Openshift Clusters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then on AppProject we can define restrictions like source repo, destination servers and resource whitelist allowed per project. Moreover you can define local roles for that AppProject.</p>
</div>
<div class="paragraph">
<p>Last but not least are <strong>namespaces</strong>. Namespaces are created as part of the bootstrap process by the argo infra instance so the operator in charge of managing apps lifecycle does not
need to have cluster wide privileges. (Add link to some article about namespaces management)</p>
</div>
<div class="paragraph">
<p>Finally push your changes to your working branch, login to argocd instance (argo hub cluster) with user-&lt;name&gt; and deploy the bootstrap Application.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">git add .
git commit -m "Your message"
git push origin sno-&lt;name&gt;-setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create bootstrap application, navigate to Argo console, click on <strong>New app</strong>, then <strong>Edit as Yaml</strong>, <strong>save</strong> and finally <strong>Create</strong>.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: managed-setup-a-&lt;name&gt;
  namespace: openshift-operators
spec:
  destination:
    namespace: openshift-operators
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: project-sno-&lt;name&gt;
  source:
    repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
    targetRevision: sno-&lt;name&gt;-setup
    path: cluster-addons/cluster-addons-as/
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point you should see some applications on syncing on your argo console. You cannot see your colleagues deployments thanks to RBAC.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/managed-setup.png" alt="managed setup">
</div>
<div class="title">Figure 2. SNO setup</div>
</div>
<div class="paragraph">
<p>Deep dive on <strong>managed-setup-a-&lt;name&gt;</strong> to check all the resources created. Next go back to the initial view and see how the Applications rendered by ApplicationSet are created.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/managed-setup-a-name.png" alt="managed setup a name">
</div>
<div class="title">Figure 3. ApplicationSet view</div>
</div>
<div class="paragraph">
<p>Then navigate to argo hub console using your user with view role, navigate to ArgoCD instance (Installed Operators &#8594; Openshift GitOps &#8594; ArgoCD), take a look to global rbac policies and then navigate to your AppProject
to verify yor local permissions.</p>
</div>
<div class="paragraph">
<p>If you try to deploy a new Application from the console you will see you cannot deploy to a different cluster destination than yours.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/clusters-list.png" alt="clusters list">
</div>
<div class="title">Figure 4. ArgoCD clusters</div>
</div>
<div class="paragraph">
<p>It happens the same with projects, you can only see yours:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/projects-list.png" alt="projects list">
</div>
<div class="title">Figure 5. ArgoCD projects</div>
</div>
<div class="paragraph">
<p>Once this is completed login to you managed cluster, and verify:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GitOps operator is installed.</p>
</li>
<li>
<p>Argo-infra instance exists and is cluster wide .</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-wide.png" alt="cluster wide">
</div>
<div class="title">Figure 6. General overview ArgoCD</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Argo-apps instance exists and is not cluster wide .</p>
</li>
<li>
<p>Existing Dev and Pro AppProject on argocd-apps instance.</p>
</li>
<li>
<p>Login as admin and verify you can create apps on dev project (argocd-apps).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Go to this <a href="https://github.com/romerobu/helm-infra-gitops-workshop.git">repo</a> and checkout to working branch, then push it.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  namespace: openshift-operators
  name: sno-&lt;name&gt;-vault
spec:
  destination:
    namespace: vault-secrets
    server: 'https://kubernetes.default.svc'
  source:
    helm:
      parameters:
        - name: vault.enabled
          value: 'true'
    path: .
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    targetRevision: sno-&lt;name&gt;
  project: dev
  syncPolicy:
    automated:
      prune: false
      selfHeal: false</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Login as user user04 (argo-dev-operators) with role operator-dev and verify you can get and sync apps on dev project.</p>
</li>
<li>
<p>Login as user apimanager01 (api-manager) and verify you do not have permissions to see apps on dev project.</p>
</li>
</ul>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-hub-setup.html">2. Deploy Hub Cluster Setup</a></span>
  <span class="next"><a href="04-day2-config.html#daytwooperations">4. Day-2 Operations</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
