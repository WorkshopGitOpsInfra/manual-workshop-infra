<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Day-2 Operations :: GitOps Infrastructure Configuration Workshop</title>
    <link rel="canonical" href="https://github.com/romerobu/manual-workshop-infra/template-tutorial/04-day2-config.html">
    <link rel="prev" href="03-sno-setup.html">
    <link rel="next" href="05-challenges.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://github.com/romerobu/manual-workshop-infra">GitOps Infrastructure Configuration Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="template-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Table of Contents</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#gettutorialsources">1.2 Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-hub-setup.html">2. Deploy Hub Cluster Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#laboverview">2.1 Lab overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#environment">2.2 Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#hub">2.3 Hub setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-sno-setup.html">3. Deploy Managed Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-sno-setup.html#managedconfiguration">3.1. Managed configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-sno-setup.html#helmcharts">3.2. Helm charts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#daytwooperations">4. Day-2 Operations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#identityproviders">4.1 Configure Identity Providers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deployoperators">4.2 Deploy Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#monitoring">4.3 Configure Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#namespace">4.4 Namespace configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#vault">4.6 Vault configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#appset">4.7 Day-2 with ApplicationSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-challenges.html">5. Challenges</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-challenges.html#challenges">5.1 Challenges</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Lab GitOps infra</a></li>
    <li><a href="#daytwooperations">4. Day-2 Operations</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/romerobu/manual-workshop-infra/edit/master/documentation/modules/ROOT/pages/04-day2-config.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Day-2 Operations</h1>
<div id="preamble">
<div class="sectionbody">
<div id="daytwooperations" class="paragraph">
<p>At this point you have a cluster with an argo instance deployed and cluster admin permissions managed by an argo hub. So you can start configuring day 2 operations.</p>
</div>
<div class="paragraph">
<p>As we might need to apply this configuration to multiple managed clusters, we need to be able to render multiple applications using helm charts, even though we are applying this configuration
to our single scoped cluster.</p>
</div>
<div class="paragraph">
<p>Go to this <a href="https://github.com/romerobu/helm-infra-gitops-workshop.git">repository</a> and checkout to your working branch.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">git checkout sno-&lt;name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take a look to the code, this repo contains helm charts for configuring day 2 operations in our managed cluster. It contains several dependencies and its charts with some default values
that you might override by creating your own values.</p>
</div>
<div class="paragraph">
<p>You can test those charts rendering using this command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>helm template . --debug -f values-&lt;chartname&gt;.yaml (optional)</pre>
</div>
</div>
<div class="paragraph">
<p>You can apply charts, first by creating a single Application that applies charts all-in-one or creating a single Application per chart or kind of configuration to be applied.
Do it on <strong>argocd-infra</strong>, the instance intended for infra management.</p>
</div>
<div class="paragraph">
<p>If you try to deploy this Application on your cluster you will see it syncs, but it does not render objects as every value is disabled.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: day-2-sno-&lt;name&gt;
  namespace: openshift-gitops
spec:
  destination:
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      valueFiles:
        - values.yaml
    path: .
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    targetRevision: sno-&lt;name&gt;
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/day-2-sno-initial-app.png" alt="day 2 sno initial app">
</div>
<div class="title">Figure 1. Day 2 initial app</div>
</div>
<div class="paragraph">
<p>This is because dependencies include conditions for enabling/disabling those charts. As every value is set to false it does not apply anything.</p>
</div>
<div class="paragraph">
<p>Then delete this Application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="identityproviders"><a class="anchor" href="#identityproviders"></a>Configure Identity Providers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you can see, there is already a local identity provider configured but we want to override current users and integrate with other identity providers like LDAP Free Ipa provider and Keycloak.</p>
</div>
<div class="paragraph">
<p>For configuring Identity Providers on Openshift you just need to modify the existing oauth resource with the provider and its configuration data.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Learn more about <a href="https://docs.openshift.com/container-platform/4.12/authentication/identity_providers/configuring-htpasswd-identity-provider.html">Oauth</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For some of them we just need to set up the integration while for others like LDAP apart from the integration agains the server we also need to synchronize groups and users.</p>
</div>
<div class="paragraph">
<p>Lets deploy the oauth resources required and verify how groups are synchronized.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
keycloak and FreeIPA server are running on argo hub cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First we need to take a look to <strong>oauth</strong> chart values. As you can see you need to define some missing values for each managed cluster. You can do this by setting those on chart values file, setting them as parametes or defining a new values file for your deployment.</p>
</div>
<div class="paragraph">
<p>Go to your working branch and create a file called <strong>values-oauth.yaml</strong>:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oauth:
  enabled: true # Enable dependency
  keycloak: # Update chart values
    clientid: myclient-&lt;name&gt;
    issuer: <a href="https://keycloak-keycloak.apps.argo-hub.&lt;domain&gt;.opentlc.com/realms/myrealm-&lt;name&gt" class="bare">https://keycloak-keycloak.apps.argo-hub.&lt;domain&gt;.opentlc.com/realms/myrealm-&lt;name&gt</a>;
    data: &lt;your_keycloak_secret_data&gt;
  ldap:
    sync:
      ldap_url: 'ldap://&lt;ip&gt;:&lt;nodeport&gt;'</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<strong>Keycloack secret</strong>: Login to argo-hub console, find keycloack url, login as admin/admin, navigate to your realm, then go to your client and  find your secret on Credentials tab.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then create a new Application to apply this operation:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sno-&lt;name&gt;-oauth
  namespace: openshift-gitops
spec:
  destination:
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      valueFiles:
        - values-oauth.yaml
    path: .
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    targetRevision: sno-&lt;name&gt;
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you take a look to the helm charts you will notice we do not only need to update oauth but create others resources needed for integration like secrets, cm and cron job for syncying groups.</p>
</div>
<div class="paragraph">
<p>Sync waves are needed to make sure those resources like secrets and cm for authentication exists when we update Oauth config, otherwise openshift-authentication will become Degraded.
When you update oauth values, and update existing Application you can notice how they are created in phases and not all at the same time.</p>
</div>
<div class="paragraph">
<p>For groups syncying, cron job shows last 5 executions, including the state according to the result (failed or success).</p>
</div>
<div class="paragraph">
<p>Furthermore you can notice some resources with no status (white fields). Those resources are created by Openshift for configuration issues but they are not managed by argo, that is why argo is not tracking them.
Resource tracking has been set to annotation+label on argo instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Learn more about <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/resource_tracking/">Resource tracking</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once every resource is deployed, verify authentication cluster operator is OK, logout and log in back. Then you should see new identity providers listed.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get co

oc get oauth cluster -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can try keycloack server with myuser-&lt;name&gt;/myuser-&lt;name&gt;.</p>
</div>
<div class="paragraph">
<p>You can try login to LDAP server with user paul/Passw0rd who is an admin user.</p>
</div>
<div class="paragraph">
<p>You can try login to LDAP server with user mark/Passw0rd who is an viewer user.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deployoperators"><a class="anchor" href="#deployoperators"></a>Deploy operators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once authentication is configured, we are going to deploy some operators. Operatos helm charts use range values so we can define as many operators as we want on values section.</p>
</div>
<div class="paragraph">
<p>We are going to deploy tekton, kiali, jaeger, servicemesh and nmstate operator. Furthermore we are going to deploy Service Mesh Control Plane and Member Roll and an example application called bookinfo for service mesh.</p>
</div>
<div class="paragraph">
<p>Go to your working branch and create a file called <strong>values-operators.yaml</strong>:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">operators:
  enabled: true
  operators:
    tekton:
      enabled: true
    knative:
      enabled: true
    kiali:
      enabled: true
    jaeger:
      enabled: true
    servicemesh:
      enabled: true
    nmstate:
      enabled: true
  istio:
    enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create Application:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sno-&lt;name&gt;-operators
  namespace: openshift-gitops
spec:
  destination:
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      valueFiles:
        - values-operators.yaml
    path: .
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    targetRevision: sno-&lt;name&gt;
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Helm charts includes subcription definition for each operator in the last version available in stable channel, while Install Plan is set to Automatic so we do not need to manually approve installation.
This is all set in values as parameters so we can use these charts for different installation methods by overriding those values.</p>
</div>
<div class="paragraph">
<p>In this case sync waves and healthchecks are very important as for being able to deploy bookinfo app, operator must be installed in the first place but also mesh should be configured.</p>
</div>
<div class="paragraph">
<p>If sync waves are not configured properly it will try to create resources whose api still does not exist in the cluster.</p>
</div>
<div class="paragraph">
<p>Once operators are installed you can view them as well with the Install Plan managed by argo:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/operators-install-plan.png" alt="operators install plan">
</div>
</div>
<div class="paragraph">
<p>Then, deploy bookinfo app using argocd-apps instance. You will realize you only need to deploy apps components as namespace is already managed by argocd-infra instance:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sno-&lt;name&gt;-bookinfo
  namespace: openshift-operators
spec:
  destination:
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      parameters:
        - name: bookinfo.enabled
          value: 'true'
    path: .
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    targetRevision: sno-&lt;name&gt;
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="monitoring"><a class="anchor" href="#monitoring"></a>Configure monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we are going to deploy some basic configuration about monitoring.</p>
</div>
<div class="paragraph">
<p>In Openshift 4 monitoring is enabled by default however there are lots of configurations we can modify and configure non default user defined projects monitoring stack.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Take a look to the <a href="https://docs.openshift.com/container-platform/4.12/monitoring/enabling-monitoring-for-user-defined-projects.html">monitoring documentation</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the first place we are going to enable user-defined projects monitoring. Then we will create an example app, with a Service Monitor and a custom Prometheus Rule.</p>
</div>
<div class="paragraph">
<p>Go to your working branch and create a file called <strong>values-monitoring.yaml</strong>:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">monitoring:
  enabled: true # Enable dependency</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create the Application on argocd-infra instance:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sno-&lt;name&gt;-monitoring
  namespace: openshift-gitops
spec:
  destination:
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      valueFiles:
        - values-monitoring.yaml
    path: .
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    targetRevision: sno-&lt;name&gt;
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is an easy configuration as sync waves are not a must because objects do not have direct dependencies and they do not affect to existing configurations.</p>
</div>
<div class="paragraph">
<p>Then navigate to Openshift console to verify those objects exist on the cluster and if Service Monitor is scraping your metrics properly:</p>
</div>
<div class="paragraph">
<p><strong>Add how to</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="namespace"><a class="anchor" href="#namespace"></a>Configure namespace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Part of day 2 configurations are setting namespace scoped configurations for managing networking and quotas for apps, as well as setting RBAC.</p>
</div>
<div class="paragraph">
<p>In this example, based on the last app deployment we are going to deploy some resources and objects quotas by namespace.</p>
</div>
<div class="paragraph">
<p>Therefore we are going to set some cluster and local roles.</p>
</div>
<div class="paragraph">
<p>Finally we are going to deploy a Network Policy to prevent traffic to the app. You can try enabling/disabling this feature to see how traffic is allowed and denied.</p>
</div>
<div class="paragraph">
<p>Go to your working branch and create a file called <strong>values-namespace.yaml</strong>:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">namespace:
  enabled: true # Enable dependency
  networkpolicy:
    enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create the Application on argocd-infra instance:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sno-&lt;name&gt;-namespace
  namespace: openshift-gitops
spec:
  destination:
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      valueFiles:
        - values-namespace.yaml
    path: .
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    targetRevision: sno-&lt;name&gt;
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then deploy an example app on argocd-apps instance:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sno-&lt;name&gt;-app
  namespace: openshift-operators
spec:
  destination:
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      parameters:
        - name: app.enabled
          value: 'true'
    path: .
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    targetRevision: sno-&lt;name&gt;
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you update the Application you want be able to create more than 4 pods in namespace app. Try to update replicas deployment to see if quota has been correctly applied by argo.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/app-replicas.png" alt="app replicas">
</div>
<div class="title">Figure 2. Change Replica Count</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quota-applied.png" alt="quota applied">
</div>
<div class="title">Figure 3. Quota</div>
</div>
<div class="paragraph">
<p>Deployment never progess to 5 replicas, and argo stays in Progressing trying to reconcile a not allowed values of replicas. Finally set it back to 1 replica.</p>
</div>
<div class="paragraph">
<p>Then if you try to navigate to app route you will see you are not allowed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/traffic-not-allowed.png" alt="traffic not allowed">
</div>
<div class="title">Figure 4. Application not responsible</div>
</div>
<div class="paragraph">
<p>Then disable network policy and verify how you have traffic access:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/traffic-allowed.png" alt="traffic allowed">
</div>
<div class="title">Figure 5. Application available :)</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault"><a class="anchor" href="#vault"></a>Configure vault secrets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vault by Hashicorp is a tool that allows to store and encrypt secrets to secure applications and protect sensitive data.
Vault server stores the sensitive data while a special plugin for argo retrieves this information when creating objects thanks to the use of paths and
references so we do not leave sensitive information visible in the code repository.</p>
</div>
<div class="paragraph">
<p>First of all you can see a running instance of vault on argo-hub cluster. This server stores sensitive data for configuring secrets and config maps, while on your managed cluster you can see
a secret containing credentials for authenticating with vault, a config map with plugin for using helm with vault and argo, and a special configuration on Argo CD instance.</p>
</div>
<div class="paragraph">
<p>Those resources are required to implement Argo CD Vault plugin. This plugin allows using placeholders with path to secrets on yaml fields where the secret should be replaced, and the plugin is in
charge of this substitution.</p>
</div>
<div class="paragraph">
<p>There are several ways of installing it, as sidecars plugin or as config map plugin.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This last one will be <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/config-management-plugins/#installing-a-config-management-plugin">deprecated</a> in the future.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So this installation approach follows the method initContainer + sidecar.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<a href="https://argocd-vault-plugin.readthedocs.io/en/stable/installation/#initcontainer-and-configuration-via-sidecar">initContainer + sidecar</a> documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Config map <strong>cmp-plugin</strong> defines the plugin that will be mounted in the sidecar container:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: v1
kind: ConfigMap
metadata:
  name: cmp-plugin # To be defined parameters
  namespace: openshift-operators
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: argocd-vault-plugin-helm
    spec:
      allowConcurrency: true
      discover:
        find:
          command:
            - sh
            - "-c"
            - "find . -name 'Chart.yaml' &amp;&amp; find . -name 'values.yaml'"
      init:
       command:
          - bash
          - "-c"
          - |
            helm repo add bitnami <a href="https://charts.bitnami.com/bitnami" class="bare">https://charts.bitnami.com/bitnami</a>
            helm dependency build
      generate:
        command:
          - bash
          - "-c"
          - |
            helm template . $ARGOCD_ENV_HELM_VALUES | # values passed in Application
            argocd-vault-plugin generate -s openshift-operators:argocd-vault-plugin-credentials - # generate using plugin + credentials
      lockRepo: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secret <strong>argocd-vault-plugin-credentials</strong> defines vault server address, authentication type (approle) and role credentials:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kind: Secret
apiVersion: v1
metadata:
  name: argocd-vault-plugin-credentials # To be defined parameters
  namespace: openshift-operators # argocd namespace
type: Opaque
stringData:
  VAULT_ADDR: "http://vault-vault.apps.argo-hub.sandbox1444.opentlc.com"
  AVP_TYPE: vault
  AVP_AUTH_TYPE: approle
  AVP_ROLE_ID: &lt;your_role_id&gt;
  AVP_SECRET_ID: &lt;your_secret_id&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are several <a href="https://developer.hashicorp.com/vault/docs/concepts/auth">authentication method</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then you need to configure using this plugin on argo cd:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">  repo:
    resources:
      limits:
        cpu: 1000m
        memory: 1024Mi
      requests:
        cpu: 250m
        memory: 256Mi
    env:
        - name: AVP_AUTH_TYPE # Field from argocd-vault-plugin-credentials secret
          valueFrom:
            secretKeyRef:
              key: AVP_AUTH_TYPE
              name: argocd-vault-plugin-credentials
        - name: AVP_TYPE
          valueFrom:
            secretKeyRef:
              key: AVP_TYPE
              name: argocd-vault-plugin-credentials
        - name: VAULT_ADDR
          valueFrom:
            secretKeyRef:
              key: VAULT_ADDR
              name: argocd-vault-plugin-credentials
        - name: AVP_ROLE_ID
          valueFrom:
            secretKeyRef:
              key: AVP_ROLE_ID
              name: argocd-vault-plugin-credentials
        - name: AVP_SECRET_ID
          valueFrom:
            secretKeyRef:
              key: AVP_SECRET_ID
              name: argocd-vault-plugin-credentials
    mountsatoken: true
    serviceaccount: argocd-repo-server # sa to be used
    sidecarContainers: # sidecar container running plugin
      - command:
          - /var/run/argocd/argocd-cmp-server
        image: 'quay.io/argoproj/argocd:v2.4.8'
        name: avp-helm
        volumeMounts:
          - mountPath: /var/run/argocd
            name: var-files
          - mountPath: /home/argocd/cmp-server/plugins
            name: plugins
          - mountPath: /tmp
            name: tmp-dir
          - mountPath: /home/argocd/cmp-server/config
            name: cmp-plugin
          - mountPath: /usr/local/bin/argocd-vault-plugin
            name: custom-tools
            subPath: argocd-vault-plugin
    volumeMounts:
      - mountPath: /usr/local/bin/argocd-vault-plugin
        name: custom-tools
        subPath: argocd-vault-plugin
    volumes:
      - configMap:
          name: cmp-plugin
        name: cmp-plugin
      - emptyDir: {}
        name: custom-tools
      - emptyDir: {}
        name: tmp-dir
    initContainers: # init container
      - args:
          - &gt;-
            wget -O /custom-tools/argocd-vault-plugin
            <a href="https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v${AVP_VERSION}/argocd-vault-plugin_${AVP_VERSION}_linux_amd64" class="bare">https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v${AVP_VERSION}/argocd-vault-plugin_${AVP_VERSION}_linux_amd64</a>
            &amp;&amp; chmod +x /custom-tools/argocd-vault-plugin &amp;&amp; ls -la
            /custom-tools/
        command:
          - sh
          - '-c'
        env:
          - name: AVP_VERSION
            value: 1.14.0
        image: 'alpine:3.8'
        name: download-tools
        volumeMounts:
          - mountPath: /custom-tools
            name: custom-tools


  configManagementPlugins: | # register plugin
    - name: argocd-vault-plugin
      generate:
        command: ["argocd-vault-plugin"]
        args: ["generate", "./"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, this configuration is already running on your cluster. If you take a look to the configuration applied by the Application on your single node where those resources have been already created as part of bootstrapping.
So the next step is testing this actually works.</p>
</div>
<div class="paragraph">
<p>In the <a href="https://github.com/romerobu/helm-infra-gitops-workshop">helm-infra-gitops-workshop</a> repository, in vault chart, you can find a secret using a vault placeholder in charts/vault/values.yaml:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">  placeholder: "&lt;password | base64encode&gt;"
  path: "kv-v2/data/demo"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you take a look to the existing secret in vault-secrets namespace, as we are telling Application to use vault plugin, it is not replacing the sensitive information:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/secret-vault.png" alt="secret vault">
</div>
<div class="title">Figure 6. Encoded data</div>
</div>
<div class="paragraph">
<p>So we need to modify existing application sno-&lt;name&gt;-vault (argocd-apps) to use plugin. Replace only the plugin section:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">...
  source:
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    path: .
    targetRevision: sno-&lt;name&gt;
    plugin:
      env:
        - name: HELM_VALUES
          value: &gt;-
            --set vault.enabled=true
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see this application is slightly different to the last one used. This is due to we need to pass values files and parameters so argocd-vault-plugin-helm can used them
to render helm charts. This might looks slightly different depending on you repository structure. If you do not need to pass any plugin you can simply invoke "plugin: {}".</p>
</div>
<div class="paragraph">
<p>After applying this new application, it will be out of sync for some seconds. Once it is synced, navigate to your Openshift cluster and verify vault has replaced secret data properly.
You can try to delete it and see how it is created. Finally you can ask your instructor to update this secret on vault server, try a hard refresh on argo and see how it is updated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appset"><a class="anchor" href="#appset"></a>Render Applications using ApplicationSet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Until now you have applied day 2 operations by creating single Applications by hand. However there is an easier way to render those apps using ApplicationSets.</p>
</div>
<div class="paragraph">
<p>Checkout to <strong>main-day2</strong> branch in this <a href="https://github.com/romerobu/workshop-gitops-content-deploy.git">repo</a> to take a look:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">git branch # main
git checkout main-day2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Navigate to the ApplicationSet folder and take a look to the newly added day2-sno-as file.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: day2-sno-&lt;name&gt;
  namespace: openshift-operators
spec:
  generators:
  - git:
      repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
      revision: sno-&lt;name&gt;-setup
      files:
      - path: "cluster-definition/**/cluster.json"
  template:
    metadata:
      name: 'day2-{{cluster.name}}-a'
    spec:
      project: '{{project}}'
      source:
        repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
        targetRevision: sno-&lt;name&gt;-setup
        path: cluster-addons/day2-as
      destination:
        server: '{{cluster.address}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This ApplicationSet render 'N' configurations for 'N' managed clusters.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagram-6.png" alt="diagram 6">
</div>
<div class="title">Figure 7. ApplicationSet</div>
</div>
<div class="paragraph">
<p>This ApplicationSet applies day 2 configurations by creating Application on argocd-infra instance on managed cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagram-7.png" alt="diagram 7">
</div>
<div class="title">Figure 8. Application</div>
</div>
<div class="paragraph">
<p>If you navigate to the charts folder, you will see you are not creating objects itself but Applications. Lets test it.</p>
</div>
<div class="paragraph">
<p>Go back to your working branch (<strong>sno-&lt;name&gt;-setup</strong>) and merge it with <strong>main-day2</strong> branch. You must see this extra ApplicationSet plus a new day2-as folder on charts.
You might need to resolve some conflicts, and make sure your lab data like repo username, domain and branches name are properly replaced.</p>
</div>
<div class="paragraph">
<p>If you take a look to this ApplicationSet which will be created in argocd-infra on destination cluster, you will see this generator iterates over config-definition folder on
root directory and uses ever child folder name (day 2 operators) to name the Application template and it takes the values file from the config.json file.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: day2-as-sno-&lt;name&gt;
  namespace: openshift-gitops
spec:
  generators:
  - git:
      repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
      revision: sno-&lt;name&gt;-setup
      files:
      - path: "config-definition/**/config.json"
  template:
    metadata:
      name: 'sno-&lt;name&gt;-{{path.basename}}'
    spec:
      project: default
      source:
        repoURL: <a href="https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git" class="bare">https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git</a>
        targetRevision: sno-&lt;name&gt;
        path: .
        helm:
          valueFiles:
            - '{{valuesFile}}'
      destination:
        server: 'https://kubernetes.default.svc'
        namespace: openshift-gitops
      syncPolicy:
        automated:
          prune: true
          selfHeal: true</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Replaced with your cluster configuration data as required.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then push to your working branch.</p>
</div>
<div class="paragraph">
<p>Finally, navigate to argo hub instance and see the recently created ApplicationSet, then navigate to argocd-infra instance on managed cluster and see the Applications managed by the Application generated by ApplicationSet.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagram-8.png" alt="diagram 8">
</div>
<div class="title">Figure 9. GitOps approach for infra and apps deployment</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-sno-setup.html">3. Deploy Managed Setup</a></span>
  <span class="next"><a href="05-challenges.html">5. Challenges</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
