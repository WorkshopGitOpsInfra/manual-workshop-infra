<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy Hub Cluster Setup :: GitOps Infrastructure Configuration Workshop</title>
    <link rel="canonical" href="https://github.com/romerobu/manual-workshop-infra/template-tutorial/02-hub-setup.html">
    <link rel="prev" href="01-setup.html">
    <link rel="next" href="03-sno-setup.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://github.com/romerobu/manual-workshop-infra">GitOps Infrastructure Configuration Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="template-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Table of Contents</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#gettutorialsources">1.2 Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-hub-setup.html">2. Deploy Hub Cluster Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#laboverview">2.1 Lab overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#environment">2.2 Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#hub">2.3 Hub setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-sno-setup.html">3. Deploy Managed Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-sno-setup.html#managedconfiguration">3.1. Managed configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-sno-setup.html#helmcharts">3.2. Helm charts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-day2-config.html#daytwooperations">4. Day-2 Operations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#identityproviders">4.1 Configure Identity Providers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#deployoperators">4.2 Deploy Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#monitoring">4.3 Configure Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#namespace">4.4 Namespace configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#vault">4.6 Vault configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#appset">4.7 Day-2 with ApplicationSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-challenges.html">5. Challenges</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-challenges.html#challenges">5.1 Challenges</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Lab GitOps infra</a></li>
    <li><a href="02-hub-setup.html">2. Deploy Hub Cluster Setup</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/romerobu/manual-workshop-infra/edit/master/documentation/modules/ROOT/pages/02-hub-setup.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Deploy Hub Cluster Setup</h1>
<div class="sect1">
<h2 id="laboverview"><a class="anchor" href="#laboverview"></a>Lab overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab we are covering a GitOps infrastructure configuration approach.
We will set an argo of argos and app of apps architecture to manage setup on destination clusters, and will apply day 2 operations on managed clusters.</p>
</div>
<div class="paragraph">
<p>Argo hub is a common cluster for every user in this workshop that will be used for deploying the basic infrastructure on managed clusters using ApplicationSet. Managed clusters are a set of Single Node OpenShift available for every user and day 2 operations will setup based on gitops instance running on managed cluster.</p>
</div>
<div class="paragraph">
<p>Take a look at the general overview of the lab.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will be able to connect to both argo-hub and managed clusters.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagram-1.png" alt="diagram 1">
</div>
<div class="title">Figure 1. Laboratory overview</div>
</div>
<div class="paragraph">
<p>First of all, when you install GitOps operator, it will deploy a default argo instance which is intended for cluster configuration. So in this instance you will find an Application hub-setup
which is deploying and managing a second argocd instance and its configuration.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagram-2.png" alt="diagram 2">
</div>
<div class="title">Figure 2. Argo Hub instances</div>
</div>
<div class="paragraph">
<p>Then as an user lab, you will access to the second argo instance where you will have privileges enough thanks to RBAC configuration to deploy an Application for applying ApplicationSets to apply configuration on your managed cluster. In this instance you can expect two ApplicationSet: gitops-setup and bootstrap-sno.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagram-3.png" alt="diagram 3">
</div>
<div class="title">Figure 3. Argo Hub configuration</div>
</div>
<div class="paragraph">
<p>Gitops-setup ApplicationSet will install the operator and the argocd-infra instance, while the second one will generate 'N' Applications on managed clusters for bootrstrapping the argocd-apps instance and setup its configuration.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagram-4.png" alt="diagram 4">
</div>
<div class="title">Figure 4. Argo Hub deploying on SNO</div>
</div>
<div class="paragraph">
<p>Once GitOps is deployed on your managed cluster you can start configuring day 2 operations locally in your new provisioned argo instace.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagram-5.png" alt="diagram 5">
</div>
<div class="title">Figure 5. Day 2 operations and applications deploy</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="environment"><a class="anchor" href="#environment"></a>Enviroment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have access to two clusters, <strong>argo-hub</strong> and your own SNO.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Learn more about <strong><a href="https://www.redhat.com/en/blog/meet-single-node-openshift-our-smallest-openshift-footprint-edge-architectures">Sigle Node OpenShift</a></strong>, our managed-cluster in this workshop.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Login to argo-hub using <strong>user-&lt;name&gt;</strong> and to sno using <strong>admin</strong> user.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On top of that, if you login to argo console using your Openshift user, you will only have permissions over your project and destination cluster.</p>
</div>
<div class="paragraph">
<p>The reason why argo hub has permissions over your managed cluster is because this is configured as a destination server, given an authentication method.</p>
</div>
<div class="paragraph">
<p>In argo hub there is a secret in argo namespace for every managed cluster containing this information. There are several ways to implement this, you can generate an
authentication token for this purpose or you can pass kubeconfig file to give full control over the destination cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-api-sno.png" alt="cluster api sno">
</div>
<div class="title">Figure 6. Managed cluster secret in hub cluster</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hubsetup"><a class="anchor" href="#hubsetup"></a>Hub setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the hub cluster you can find two argo instances, openshift-gitops (default) and argocd. Default instance is intended to manage the hub itself, and it is in charge of
deploying the argocd instance and its configuration. While argocd is dedicated for managed clusters setup and configuration.</p>
</div>
<div class="paragraph">
<p>As argo hub setup should be done only once before this lab, you can login to openshift-gitops argo console with view permissions to take a look to the objects
argo is managing for deploying the second instance.</p>
</div>
<div class="paragraph">
<p>Then you can go to the code to take a look to the helm charts used.</p>
</div>
<div class="paragraph">
<p>First take a look to the helm charts used for argo hub setup and then navigate to the console. As this configuration is already deployed you don&#8217;t need to make any change, only observe the way it was done.</p>
</div>
<div class="paragraph">
<p>Navigate to global-config/bootstrap-a/hub-setup-a.yaml application and see how this sets up env config on in-cluster (<a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>):</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: hub-setup
  namespace: openshift-gitops
spec:
  destination:
    namespace: openshift-gitops
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: default
  source:
    repoURL: <a href="https://github.com/romerobu/workshop-gitops-content-deploy.git" class="bare">https://github.com/romerobu/workshop-gitops-content-deploy.git</a>
    targetRevision: setup-sno
    path: hub-setup/charts/gitops-setup
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then go to openshift-gitops console and take a look to the objects managed by argo. As you can see, using range of values while rendering charts allows to create charts for
multiple destinations without much complexity.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/hub-setup-app.png" alt="hub setup app">
</div>
<div class="title">Figure 7. Hub setup in ArgoCD console</div>
</div>
<div class="paragraph">
<p>For this initial setup it is only required to create argocd instance, app projects, groups and role bindings and secrets for cluster destinations.</p>
</div>
<div class="paragraph">
<p>Then once this second instance is up and running, you can login with your user-&lt;name&gt; to argo console as admin user of your own project while you will only have cluster reader permissions when you login to Openshift console.</p>
</div>
<div class="paragraph">
<p>By using this instance you will be able to setup your own managed cluster.</p>
</div>
<div class="paragraph">
<p>Ideally you could set up every managed with a single ApplicationSet by configuring multiple cluster-definition. However because of the workshop structure you need to perform cluster scoped configurations without affecting other users, but your repository could be easily adapted to perform actions on multiple clusters.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-setup.html">1. Environment Setup</a></span>
  <span class="next"><a href="03-sno-setup.html">3. Deploy Managed Setup</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
